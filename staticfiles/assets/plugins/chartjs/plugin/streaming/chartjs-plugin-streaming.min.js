/*
 * @license
 * chartjs-plugin-streaming
 * http://github.com/nagix/chartjs-plugin-streaming/
 * Version: 1.4.1
 *
 * Copyright 2018 Akihiko Kusanagi
 * Released under the MIT license
 * https://github.com/nagix/chartjs-plugin-streaming/blob/master/LICENSE.md
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("chart.js"),require("moment")):"function"==typeof define&&define.amd?define(["chart.js","moment"],t):e["chartjs-plugin-streaming"]=t(e.Chart,e.moment)}(this,function(e,t){"use strict";!function(e,p){var v=e.helpers;v.cancelAnimFrame=function(){if("undefined"!=typeof window)return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(e){return window.clearTimeout(e)}}();var t,i,h=Number.MAX_SAFE_INTEGER||9007199254740991,y={millisecond:{common:!0,size:1,steps:[1,2,5,10,20,50,100,250,500]},second:{common:!0,size:1e3,steps:[1,2,5,10,30]},minute:{common:!0,size:6e4,steps:[1,2,5,10,30]},hour:{common:!0,size:36e5,steps:[1,2,3,6,12]},day:{common:!0,size:864e5,steps:[1,2,5]},week:{common:!1,size:6048e5,steps:[1,2,3,4]},month:{common:!0,size:2628e6,steps:[1,2,3]},quarter:{common:!1,size:7884e6,steps:[1,2,3,4]},year:{common:!0,size:3154e7}},g=Object.keys(y);function w(e){for(var t=g.indexOf(e)+1,i=g.length;t<i;++t)if(y[g[t]].common)return g[t]}function s(e,t,i,a){var n,r=a.time,o=r.unit||function(e,t,i,a){var n,r,o,s=g.length;for(n=g.indexOf(e);n<s-1;++n)if(o=(r=y[g[n]]).steps?r.steps[r.steps.length-1]:h,r.common&&Math.ceil((i-t)/(o*r.size))<=a)return g[n];return g[s-1]}(r.minUnit,e,t,i),s=w(o),l=v.valueOrDefault(r.stepSize,r.unitStepSize),c="week"===o&&r.isoWeekday,u=y[o],m=p(e),d=p(t+a.realtime.delay+a.realtime.refresh),f=[];for(l||(l=function(e,t,i,a){var n,r,o,s=t-e,l=y[i],c=l.size,u=l.steps;if(!u)return Math.ceil(s/(a*c));for(n=0,r=u.length;n<r&&(o=u[n],!(Math.ceil(s/(c*o))<=a));++n);return o}(e,t,o,i)),c&&(m=m.isoWeekday(c),d=d.isoWeekday(c)),m=m.startOf(c?"day":o),(d=d.startOf(c?"day":o))<t&&d.add(1,o),n=p(m),!s||c||r.round||(n.startOf(s),n.add(~~((m-n)/(u.size*l))*l,o));n<d;n.add(l,o))f.push(+n);return f.push(+n),f}void 0!==document.hidden?(t="hidden",i="visibilitychange"):void 0!==document.msHidden?(t="msHidden",i="msvisibilitychange"):void 0!==document.webkitHidden&&(t="webkitHidden",i="webkitvisibilitychange");var b={data:["x","controlPointPreviousX","controlPointNextX"],dataset:["x"],tooltip:["x","caretX"]},M={data:["y","controlPointPreviousY","controlPointNextY"],dataset:["y"],tooltip:["y","caretY"]};function x(e,t,i){var a,n,r=e._start||{},o=e._view||{},s=e._model||{};for(a=0,n=t.length;a<n;++a){var l=t[a];r.hasOwnProperty(l)&&(r[l]-=i),o.hasOwnProperty(l)&&o!==r&&(o[l]-=i),s.hasOwnProperty(l)&&s!==o&&(s[l]-=i)}}var l=e.scaleService.getScaleConstructor("time");e.scaleService.getScaleConstructor=function(e){return"time"===e&&(e="realtime"),this.constructors.hasOwnProperty(e)?this.constructors[e]:void 0};var a=l.extend({initialize:function(){l.prototype.initialize.call(this);var m=this,d=m.chart;if("time"!==m.options.type||d.options.plugins.streaming){var f=Date.now(),p=0;document.addEventListener(i,function(){document[t]||(d.update(0),f=Date.now())},!1);var h=function(){var r,e,o,t=m.options.realtime,i=t.duration,s=m.id,a=d.tooltip,n=a._active,l=1e3/(Math.max(t.frameRate,0)||30);m.isHorizontal()?(e=m.width,r=b):(e=m.height,r=M);var c=Date.now(),u=e*(c-f)/i;v.each(d.data.datasets,function(e,t){if(o=d.getDatasetMeta(t),s===o.xAxisID||s===o.yAxisID){var i,a,n=o.data||[];for(i=0,a=n.length;i<a;++i)x(n[i],r.data,u);o.dataset&&x(o.dataset,r.dataset,u)}}),n&&n[0]&&(o=d.getDatasetMeta(n[0]._datasetIndex),s!==o.xAxisID&&s!==o.yAxisID||x(a,r.tooltip,u)),m.max=m._table[1].time=c-t.delay,m.min=m._table[0].time=m.max-i,p+l<=c&&(d.animating||d.draw(),(p+=l)+l<=c&&(p=c)),f=c,m.frameRequestID=v.requestAnimFrame.call(window,h)};m.frameRequestID=v.requestAnimFrame.call(window,h)}},buildTicks:function(){var e=this,t=e.options;if("time"===t.type&&!e.chart.options.plugins.streaming)return l.prototype.buildTicks.call(this);var i=t.time,a=t.realtime,n=Date.now()-a.delay,r=n-a.duration,o=[];switch(t.ticks.source){case"data":o=e._timestamps.data;break;case"labels":o=e._timestamps.labels;break;case"auto":default:o=s(r,n,e.getLabelCapacity(r),t)}return e.min=r,e.max=n,e._unit=i.unit||function(e,t,i,a){var n,r,o=p.duration(p(a).diff(p(i)));for(n=g.length-1;n>=g.indexOf(t);n--)if(r=g[n],y[r].common&&o.as(r)>=e.length)return r;return g[t?g.indexOf(t):0]}(o,i.minUnit,e.min,e.max),e._majorUnit=w(e._unit),e._table=[{time:r,pos:0},{time:n,pos:1}],e._offsets={left:0,right:0},e._labelFormat=function(e,t){var i,a,n,r,o,s,l,c=e.length;for(i=0;i<c;i++){if(r=e[i],l=s=void 0,s=(o=t).parser,l=o.parser||o.format,0!==(a="function"==typeof s?s(r):"string"==typeof r&&"string"==typeof l?p(r,l):(r instanceof p||(r=p(r)),r.isValid()?r:"function"==typeof l?l(r):r)).millisecond())return"MMM D, YYYY h:mm:ss.SSS a";0===a.second()&&0===a.minute()&&0===a.hour()||(n=!0)}return n?"MMM D, YYYY h:mm:ss a":"MMM D, YYYY"}(e._timestamps.data,i),function(e,t){var i,a,n,r,o=[];for(i=0,a=e.length;i<a;++i)n=e[i],r=!!t&&n===+p(n).startOf(t),o.push({value:n,major:r});return o}(o,e._majorUnit)},fit:function(){l.prototype.fit.call(this);var e=this,t=e.options;t.ticks.display&&t.display&&e.isHorizontal()&&(e.paddingLeft=3,e.paddingRight=3,e.handleMargins())},draw:function(e){var t=this.chart;if("time"===this.options.type&&!t.options.plugins.streaming)return l.prototype.draw.call(this,e);var i=this.ctx,a=this.isHorizontal()?{left:e.left,top:0,right:e.right,bottom:t.height}:{left:0,top:e.top,right:t.width,bottom:e.bottom};v.canvas.clipArea(i,a),l.prototype.draw.call(this,e),v.canvas.unclipArea(i)},destroy:function(){var e=this.frameRequestID;e&&v.cancelAnimFrame.call(window,e)}});e.scaleService.registerScaleType("realtime",a,{position:"bottom",distribution:"linear",bounds:"data",time:{parser:!1,format:!1,unit:!1,round:!1,displayFormat:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{millisecond:"h:mm:ss.SSS a",second:"h:mm:ss a",minute:"h:mm a",hour:"hA",day:"MMM D",week:"ll",month:"MMM YYYY",quarter:"[Q]Q - YYYY",year:"YYYY"}},realtime:{duration:1e4,refresh:1e3,delay:0,frameRate:30,onRefresh:null},ticks:{autoSkip:!1,source:"auto",major:{enabled:!0}}})}(e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t);var i=function(i){i.defaults.global.plugins.streaming={duration:1e4,refresh:1e3,delay:0,frameRate:30,onRefresh:null};var o=i.scaleService.getScaleConstructor("realtime");function s(e,t,i,a){var n,r;for(n=2,r=i.length;n<r&&e.getPixelForValue(null,n,a)<=t;++n);if(i.splice(0,n-2),"object"!=typeof i[0])return n-2}function r(n){var r,e=n.options.plugins.streaming;e.onRefresh&&e.onRefresh(n),n.data.datasets.forEach(function(e,t){var i=n.getDatasetMeta(t),a=i.controller.getScaleForId(i.xAxisID);a instanceof o&&(r=s(a,a.left,e.data,t)),(a=i.controller.getScaleForId(i.yAxisID))instanceof o&&(r=s(a,a.top,e.data,t))}),r&&n.data.labels.splice(0,r),n._bufferedRender=!0,n.update(),n._bufferedRender=!1,n._bufferedRequest=null}return{id:"streaming",afterInit:function(e,t){e.refreshTimerID=setInterval(function(){r(e)},t.refresh)},beforeUpdate:function(e,t){var i,a=e.options,n=a.scales;return a.elements.line.capBezierPoints=!1,n.xAxes.concat(n.yAxes).forEach(function(e){"realtime"!==e.type&&"time"!==e.type||((i=e.realtime)||(i=e.realtime={}),i.duration=t.duration,i.refresh=t.refresh,i.delay=t.delay,i.frameRate=t.frameRate,i.onRefresh=r)}),!0},beforeDraw:function(e){var t=e.lastMouseMoveEvent;if(t)if("function"==typeof MouseEvent)e.canvas.dispatchEvent(t);else{var i=document.createEvent("MouseEvents");i.initMouseEvent(t.type,t.bubbles,t.cancelable,t.view,t.detail,t.screenX,t.screenY,t.clientX,t.clientY,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.button,t.relatedTarget),e.canvas.dispatchEvent(i)}return!0},beforeEvent:function(e,t){return"mousemove"===t.type?e.lastMouseMoveEvent=t.native:"mouseout"===t.type&&delete e.lastMouseMoveEvent,!0},destroy:function(e){var t=e.refreshTimerID;t&&clearInterval(t),i.helpers.each(e.scales,function(e){e instanceof o&&e.destroy()})}}}(e);return e.plugins.register(i),i});